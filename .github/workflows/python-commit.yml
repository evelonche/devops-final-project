name: Python commit pipeline
run-name: ${{ github.actor }} made a commit to the Python directory
  
on:
  push:
    branches: [ ftr/* ]
      #    paths: [ training/** ]

jobs:
  pylint:
    name: "Check with Pylint"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: cclauss/GitHub-Action-for-pylint@0.7.0

  black:
    name: "Check formatting with Black"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: psf/black@stable

  gitleaks:
    name: "Check for leaks in secrets with gitleaks"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sonar_cloud:
    name: "Run SonarCloud"
    runs-on: ubuntu-latest
    needs: gitleaks
    steps:
    - uses: actions/checkout@v4
    - uses: AppThreat/sast-scan-action@master
      with:
        type: "python"

  mlflow-build-push:
    name: "Build Docker image, check for vulneratibilities and push"
    runs-on: ubuntu-latest
    needs: sonar_cloud
    steps:
    - name: "Checkout"
      uses: actions/checkout@v4
    - name: "Set up QEMU"
      uses: docker/setup-qemu-action@v3
    - name: "Set up BuildX"
      uses: docker/setup-buildx-action@v3
    - name: "Login to Docker Hub"
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN}}
    - name: "Build and export to Docker (without push)"
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./mlflow.Dockerfile
        push: false
        tags: evelonche/mlflow:${{ github.sha }}
    - name: "Scan image"
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: evelonche/mlflow:${{ github.sha }}
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: "Push image"
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./mlflow.Dockerfile
        push: true
        tags: evelonche/mlflow:${{ github.sha }}

          #    training-build-push:
          #    name: "Build Docker image, check for vulneratibilities and push"
          #    runs-on: ubuntu-latest
          #    needs: vulnerability
          #    steps:
          #    - name: "Checkout"
          #      uses: actions/checkout@v4
          #    - name: "Set up QEMU"
          #      uses: docker/setup-qemu-action@v3
          #    - name: "Set up BuildX"
          #      uses: docker/setup-buildx-action@v3
          #    - name: "Login to Docker Hub"
          #      uses: docker/login-action@v3
          #      with:
          #        username: ${{ secrets.DOCKERHUB_USERNAME }}
          #        password: ${{ secrets.DOCKERHUB_TOKEN}}
          #    - name: "Build and export to Docker (without push)"
          #      uses: docker/build-push-action@v3
          #      with:
          #        context: .
          #        load: true
          #        tags: evelonche/app:${{ github.sha }}
          #    - name: "Scan image"
          #      uses: aquasecurity/trivy-action@master
          #      with:
          #        image-ref:
          #        format: 'table'
          #        exit-code: '1'
          #        ignore-unfixed: true
          #        vuln-type: 'os,library'
          #        severity: 'CRITICAL,HIGH'
